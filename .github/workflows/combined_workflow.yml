
name: Combined Daily Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    # Runs at 04:00 UTC on every day-of-week from Monday to Friday.
    - cron: '0 4 * * 1-5'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # We need to fetch all history for the commit steps
        fetch-depth: 0

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/setup.py', '**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install System and Python Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y poppler-utils rsync
        pip install --upgrade pip
        pip install --upgrade ipython ipykernel
        ipython kernel install --name "python3" --user
        pip install ".[docs]"

    - name: Cache Sphinx build
      uses: actions/cache@v4
      with:
        path: docs/_build
        key: ${{ runner.os }}-sphinx-${{ hashFiles('docs/**/*.ipynb', 'docs/**/*.html') }}

    - name: Build Docs
      working-directory: ./docs
      run: make html

    - name: Cleanup old summaries (>3 months)
      if: |
        github.event_name == 'push' && github.ref == 'refs/heads/main' ||
        github.event_name == 'schedule' ||
        github.event_name == 'workflow_dispatch'
      run: |
        python cleanup_old_summaries.py --force --days 90
        echo "Cleanup completed. Remaining files:" >> $GITHUB_STEP_SUMMARY
        echo "- $(find docs/_build/html -name '*.md' | wc -l) markdown files" >> $GITHUB_STEP_SUMMARY
        echo "- $(du -sh docs/_build/html | cut -f1) total size" >> $GITHUB_STEP_SUMMARY

    - name: Create Change Summary for Logs
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      working-directory: ./docs
      run: |
        echo "# last log :ðŸªµ" >> $GITHUB_STEP_SUMMARY
        cat "$(find ./_build/html/logs -name 'log-*.md' | sort | tail -n 1)" >> $GITHUB_STEP_SUMMARY
        echo "## new outputs! :rocket:" >> $GITHUB_STEP_SUMMARY
        git status --porcelain docs/_build/html/ | grep '^.M' | sed 's/^.M //' >> $GITHUB_STEP_SUMMARY || echo "No modified files."

    - name: Commit logs and build files to main branch
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/log.ipynb
        git add docs/_build/html/
        if git diff --staged --quiet; then
          echo "No changes to commit to main branch."
        else
          git commit -m "chore: update daily logs and build files [ci skip]"
        fi

    - name: Push log and build changes to main branch
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
        force: true

    - name: Incremental Deploy to GitHub Pages
      if: |
        github.event_name == 'push' && github.ref == 'refs/heads/main' ||
        github.event_name == 'schedule' ||
        github.event_name == 'workflow_dispatch'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Configure git
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"

        # Clone the gh-pages branch into a local directory
        git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" --branch gh-pages --single-branch gh-pages

        # Use rsync to incrementally update the gh-pages directory
        # --delete will remove files in gh-pages that are no longer in the build output
        rsync -av --delete --exclude='.git' docs/_build/html/ gh-pages/

        # Check for changes and deploy
        cd gh-pages
        if [ -z "$(git status --porcelain)" ]; then
          echo "No changes to deploy."
          exit 0
        fi

        git add .
        git commit -m "docs: incremental update of daily digest"
        git push origin gh-pages
